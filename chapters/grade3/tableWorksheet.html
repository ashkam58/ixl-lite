<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grade 3 â€¢ Multiplication Table Worksheet</title>
  <link rel="stylesheet" href="../../assets/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* Local styles for the multiplication table worksheet */
    .mult-table { border-collapse: collapse; margin: 0 auto; box-shadow: 0 8px 30px rgba(16,24,40,0.08); border-radius: 12px; overflow: hidden; }
    .mult-table th, .mult-table td { padding: 10px 12px; text-align: center; border: 1px solid rgba(16,24,40,0.06); }
    .mult-table thead th { background: linear-gradient(90deg,#7dd3fc,#60a5fa); color: #04233b; font-weight: 700; font-size: 1rem; }
    .mult-table tbody td { background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,255,0.9)); }
    .mult-table tbody td:nth-child(even){ background: linear-gradient(180deg, rgba(245,250,255,0.9), rgba(238,246,255,0.95)); }
    .mult-input { width:64px; padding:8px; font-size:16px; font-weight:700; text-align:center; border-radius:8px; border:2px solid transparent; transition: all 200ms ease; }
    .mult-input:focus { outline:none; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(59,130,246,0.12); border-color: rgba(37,99,235,0.18); }
    .mult-input.correct { background: linear-gradient(90deg,#bbf7d0,#86efac); color:#065f46; border-color: rgba(6,95,70,0.12); }
    .mult-input.wrong { background: linear-gradient(90deg,#fee2e2,#fecaca); color:#7f1d1d; border-color: rgba(239,68,68,0.12); }
    .mult-input.hint { background: linear-gradient(90deg,#fff7ed,#fde68a); color:#92400e; border-color: rgba(245,158,11,0.12); }
    .cell-sparkle { position: absolute; pointer-events:none; transform: translate(-50%,-50%); font-size:18px; animation: sparkle 700ms ease-out; }
    .hud-progress { height:10px; background: rgba(0,0,0,0.06); border-radius:8px; overflow:hidden; margin-top:8px; }
    .hud-progress > i { display:block; height:100%; width:0%; background: linear-gradient(90deg,#60a5fa,#7c3aed); transition: width 600ms cubic-bezier(.2,.9,.3,1); }
  </style>
</head>
<body>
  <!-- Floating Background Shapes -->
  <!-- <div class="floating-shapes">
    <div class="floating-shape" style="top: 15%; left: 5%; font-size: 50px;">ğŸ¦¸â€â™€ï¸</div>
    <div class="floating-shape" style="top: 25%; right: 10%; font-size: 45px;">ğŸ¦„</div>
    <div class="floating-shape" style="top: 65%; left: 8%; font-size: 55px;">ğŸª</div>
    <div class="floating-shape" style="top: 75%; right: 5%; font-size: 40px;">ğŸŒŸ</div>
    <div class="floating-shape" style="top: 45%; left: 80%; font-size: 35px;">ğŸ­</div>
  </div> -->

  <div class="topbar">
    <div class="wrap">
      <div class="brand"><span class="logo"></span> AIS Practice</div>
      <a class="btn ghost" href="../../index.html">ğŸ  Home</a>
      <div class="row small muted" style="margin-left:auto">
        <span>Topic:</span><strong id="topic-title" style="color: var(--text-light);">âœ–ï¸ Grade 3 â€¢ Multiplication Table Worksheet</strong>
      </div>
    </div>
  </div>

  <div class="container">
    <main>
      <section class="card prompt">
        <h2>ğŸ§® Multiplication Table Practice</h2>
        <p>Fill in the blanks in the multiplication table! Some answers are already filled to help you. Click "Check" to see if you're right.</p>
      </section>
      <section class="card workspace">
        <div id="table-container"></div>
        <div class="actions">
          <button id="checkBtn" class="btn primary">âœ¨ Check Answers</button>
          <button id="hintBtn" class="btn">ğŸ’¡ Hint</button>
          <button id="resetBtn" class="btn">ğŸ”„ Reset</button>
          <button id="nextBtn" class="btn">â¡ï¸ Next Worksheet</button>
        </div>
        <div id="feedback" class="feedback"></div>
      </section>
      <nav class="nav-rail">
        <button id="prevTopic" class="btn">â† Prev Topic</button>
        <button id="nextTopic" class="btn">Next Topic â†’</button>
      </nav>
    </main>
    <aside>
      <section class="card hud">
        <div class="tile">ğŸ† Score<br><strong id="score">0</strong></div>
        <div class="tile">ğŸ¯ Attempts<br><strong id="attempts">0</strong></div>
        <div class="tile">ğŸ“ˆ Mastery<br><strong id="mastery">0%</strong>
          <div class="hud-progress" aria-hidden="true" style="margin-top:8px"><i id="progressBar" style="width:0%"></i></div>
        </div>
      </section>
      <section class="card">
        <div>ğŸ”¥ Streak: <strong id="streakVal">0</strong></div>
        <p class="small muted">Tip: Press Enter to check faster.</p>
      </section>
      <section class="card">
        <h4 style="margin-top:0">ğŸ¯ Table Tips</h4>
        <ul class="small" style="margin:0;padding-left:16px">
          <li>ğŸ§  Patterns: Each row increases by the multiplier</li>
          <li>ğŸ”¢ Skip counting: 2,4,6,8... for Ã—2</li>
          <li>â• Repeated addition: 3Ã—4 = 4+4+4</li>
          <li>ğŸ‘ï¸ Look for familiar numbers!</li>
        </ul>
      </section>
    </aside>
  </div>

  <!-- Mascot for feedback -->
  <div id="mascot" style="position:fixed; bottom:20px; right:20px; display:none;">
    <div style="background:#fff; border-radius:50%; padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
      ğŸ»â€â„ï¸
    </div>
    <div id="mascotBubble" style="background:#333; color:#fff; padding:8px 12px; border-radius:12px; margin-bottom:5px; display:none; font-size:14px;"></div>
  </div>

  <!-- Confetti Canvas -->
  <canvas id="confettiCanvas" style="position:fixed; top:0; left:0; pointer-events:none; z-index:10;"></canvas>

  <script src="../../engine/ui.js"></script>
  <script src="../../engine/core.js"></script>
  <script>
    // Generate multiplication table
    const tableContainer = document.getElementById('table-container');
    const size = 10; // 1 to 10
    const blanks = new Set(); // cells that are blanks

    // Randomly select some cells to be blanks (e.g., ~30% blank)
    // NOTE: we iterate only over real cells (1..size) so headers are unaffected.
    for(let i=1; i<=size; i++){
      for(let j=1; j<=size; j++){
        if(Math.random() < 0.30){
          blanks.add(`${i}-${j}`);
        }
      }
    }

    let tableHTML = '<table class="mult-table">';
    for(let i=0; i<=size; i++){
      tableHTML += '<tr>';
      for(let j=0; j<=size; j++){
        if(i===0 && j===0){
          tableHTML += '<th></th>';
        }else if(i===0){
          tableHTML += `<th>${j}</th>`;
        }else if(j===0){
          tableHTML += `<th>${i}</th>`;
        }else{
          const key = `${i}-${j}`;
          if(blanks.has(key)){
            tableHTML += `<td><input inputmode="numeric" pattern="[0-9]*" type="text" id="cell-${key}" class="mult-input" autocomplete="off" /></td>`;
          }else{
            tableHTML += `<td>${i*j}</td>`;
          }
        }
      }
      tableHTML += '</tr>';
    }
    tableHTML += '</table>';
    tableContainer.innerHTML = tableHTML;

    // Variables for progress
    let score = 0;
    let attempts = 0;
    let streak = 0;
    let totalBlanks = blanks.size;

    // Update UI
    function updateUI(){
      document.getElementById('score').textContent = score;
      document.getElementById('attempts').textContent = attempts;
      // calculate correct filled cells
      const correctCount = Array.from(blanks).reduce((acc, key) => {
        const input = document.getElementById(`cell-${key}`);
        if(!input) return acc;
        const v = (input.value||'').toString().trim();
        if(!v) return acc;
        const [a,b] = key.split('-').map(Number);
        return acc + (parseInt(v,10) === a*b ? 1 : 0);
      }, 0);
      const pct = totalBlanks ? Math.round((correctCount / totalBlanks) * 100) : 100;
      document.getElementById('mastery').textContent = pct + '%';
      const bar = document.getElementById('progressBar'); if(bar) bar.style.width = pct + '%';
      document.getElementById('streakVal').textContent = streak;
    }

    // Check answers
    document.getElementById('checkBtn').addEventListener('click', checkAnswers);
    function checkAnswers(){
      attempts++;
      let correct = 0;
      let wrong = [];
      blanks.forEach(key => {
        const [i,j] = key.split('-').map(Number);
        const input = document.getElementById(`cell-${key}`);
        if(!input) return;
        const raw = (input.value||'').toString().trim();
        if(raw === ''){
          wrong.push(key);
          input.classList.remove('correct','hint');
          input.classList.add('wrong');
        }else{
          const val = parseInt(raw, 10);
          if(!Number.isNaN(val) && val === i*j){
            correct++;
            input.classList.remove('wrong','hint');
            input.classList.add('correct');
            input.disabled = true; // lock correct answers
          }else{
            wrong.push(key);
            input.classList.remove('correct','hint');
            input.classList.add('wrong');
          }
        }
      });
      score = correct;
      updateUI();
      if(correct === totalBlanks){
        streak++;
        feedback('ğŸ‰ All correct! Great job!', 'good');
        shootConfetti();
        say('You mastered the table! ğŸ†');
        beep(true);
      }else{
        streak = 0;
        feedback(`âœ… ${correct}/${totalBlanks} correct. Keep going!`, 'oops');
        say('Keep trying! ğŸ’ª');
        beep(false);
      }
    }

    // Hint: fill one wrong or random blank
    document.getElementById('hintBtn').addEventListener('click', giveHint);
    function giveHint(){
      // Prefer a wrong or empty cell to hint
      const candidates = Array.from(blanks).filter(key => {
        const input = document.getElementById(`cell-${key}`);
        if(!input) return false;
        const v = (input.value||'').toString().trim();
        const [a,b] = key.split('-').map(Number);
        return v === '' || parseInt(v,10) !== a*b;
      });
      if(candidates.length === 0){
        feedback('All blanks look correct! ğŸ‰', 'good');
        return;
      }
      const key = candidates[Math.floor(Math.random() * candidates.length)];
      const [i,j] = key.split('-').map(Number);
      const input = document.getElementById(`cell-${key}`);
      if(input){
        input.value = i*j;
        input.classList.remove('wrong');
        input.classList.add('hint');
        // briefly pulse the hint color then leave for student to confirm
        setTimeout(()=>{ input.classList.remove('hint'); }, 1500);
        feedback('ğŸ’¡ Hint filled one cell. Check your answers!', '');
        updateUI();
      }
    }

    // Reset: regenerate table
    document.getElementById('resetBtn').addEventListener('click', resetTable);
    function resetTable(){
      location.reload(); // simple reset
    }

    // Next: new blanks
    document.getElementById('nextBtn').addEventListener('click', nextWorksheet);
    function nextWorksheet(){
      resetTable(); // for now
    }

    // Keyboard
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter') checkAnswers();
    });

    // Feedback
    function feedback(text, cls){
      const fb = document.getElementById('feedback');
      fb.textContent = text;
      fb.className = 'feedback ' + cls;
    }

    // Confetti
    const c = document.getElementById('confettiCanvas');
    const ctx = c.getContext('2d');
    let particles = [];
    function resize(){ c.width = innerWidth; c.height = innerHeight; }
    addEventListener('resize', resize); resize();

    function shootConfetti(bursts=160){
      particles.length = 0;
      for(let i=0;i<bursts;i++){
        particles.push({
          x: c.width/2, y: c.height*0.25,
          vx: (Math.random()*6-3), vy: (Math.random()*-6-2),
          g: 0.12 + Math.random()*0.08,
          w: 4+Math.random()*4, h: 8+Math.random()*8,
          a: Math.random()*Math.PI, va:(Math.random()-.5)*0.2,
          hue: Math.floor(200+ Math.random()*140)
        });
      }
      animateConfetti();
    }
    function animateConfetti(){
      ctx.clearRect(0,0,c.width,c.height);
      particles.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.vy += p.g; p.a += p.va;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
        ctx.fillStyle = `hsl(${p.hue} 90% 60%)`;
        ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        ctx.restore();
      });
      particles = particles.filter(p=> p.y < c.height+20);
      if(particles.length) requestAnimationFrame(animateConfetti);
    }

    // Mascot talk
    const mascot = document.getElementById('mascot');
    const bubble = document.getElementById('mascotBubble');
    const linesGood = [
      "Boom! Tables tamed! ğŸ¯",
      "Math muscles flexed! ğŸ’ª",
      "Chef's kiss Ã— 3! ğŸ‘¨â€ğŸ³ğŸ˜™",
      "You multiplied the fun! ğŸ‰"
    ];
    const linesTry = [
      "Close! Count the groups ğŸ‘€",
      "Try skip-counting again! ğŸ”¢",
      "No stressâ€”math is practice ğŸŒˆ",
      "Tiny tweak and you've got it! ğŸ§©"
    ];
    function say(text){
      bubble.textContent = text;
      mascot.style.display = 'block';
      bubble.style.display = 'block';
      clearTimeout(say._t);
      say._t = setTimeout(()=> { mascot.style.display = 'none'; bubble.style.display = 'none'; }, 3000);
    }
    function beep(good=true){
      const actx = new (window.AudioContext||window.webkitAudioContext)();
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type='sine';
      o.frequency.value = good ? 880 : 220;
      o.connect(g); g.connect(actx.destination);
      g.gain.setValueAtTime(0.0001, actx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, actx.currentTime+.02);
      g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+.22);
      o.start(); o.stop(actx.currentTime+.24);
    }

    // Initial say
    setTimeout(()=>say("Ready to fill the table? ğŸš€"), 1000);

    updateUI();
  </script>
</body>
</html>
<script>
  (function(){
    const parts = location.pathname.split('/').filter(Boolean);
    const depth = Math.max(0, parts.length - 1);
    const prefix = '../'.repeat(depth);
    const s = document.createElement('script');
    s.src = prefix + 'assets/global-nav.js';
    s.defer = true;
    document.body.appendChild(s);
  })();
</script>
